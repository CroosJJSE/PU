<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Cleanup Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }

        .log-container.active {
            display: block;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.warning {
            color: #fdcb6e;
        }

        .log-entry.success {
            color: #00b894;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .collection-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .collection-card h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .field-list {
            list-style: none;
        }

        .field-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-list li:last-child {
            border-bottom: none;
        }

        .field-name {
            font-weight: 500;
        }

        .field-type {
            color: #666;
            font-size: 0.8rem;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending {
            background: #fdcb6e;
        }

        .status-processing {
            background: #667eea;
        }

        .status-completed {
            background: #00b894;
        }

        .status-error {
            background: #ff6b6b;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .collections-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è Database Cleanup Tool</h1>
            <p>Clean your Firestore database by removing unwanted fields</p>
        </div>

        <div class="warning">
            ‚ö†Ô∏è <strong>WARNING:</strong> This tool will permanently delete data from your database. Always test in dry-run mode first and ensure you have backups!
        </div>

        <div class="content">
            <!-- Mode Selection -->
            <div class="section">
                <h3>üîß Operation Mode</h3>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="dryRunMode" checked>
                        <label for="dryRunMode">Dry Run Mode (Recommended - No actual changes)</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="liveMode">
                        <label for="liveMode">Live Mode (‚ö†Ô∏è Will make actual changes)</label>
                    </div>
                </div>
            </div>

            <!-- Collection Selection -->
            <div class="section">
                <h3>üìÅ Collections to Clean</h3>
                <div class="collections-grid">
                    <div class="collection-card">
                        <h4>üë• Students</h4>
                        <ul class="field-list">
                            <li><span class="field-name">indexNo</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">name</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">batch</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">phone</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">email</span> <span class="field-type">string</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanStudents" checked>
                            <label for="cleanStudents">Clean this collection</label>
                        </div>
                    </div>

                    <div class="collection-card">
                        <h4>üìÖ Class Attendance</h4>
                        <ul class="field-list">
                            <li><span class="field-name">date</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">studentId</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">attended</span> <span class="field-type">boolean</span></li>
                            <li><span class="field-name">timestamp</span> <span class="field-type">timestamp</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanClassAttendance" checked>
                            <label for="cleanClassAttendance">Clean this collection</label>
                        </div>
                    </div>

                    <div class="collection-card">
                        <h4>üìù Exams</h4>
                        <ul class="field-list">
                            <li><span class="field-name">batch</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">subject</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">date</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">status</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">attendance</span> <span class="field-type">object</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanExams" checked>
                            <label for="cleanExams">Clean this collection</label>
                        </div>
                    </div>

                    <div class="collection-card">
                        <h4>üí∞ Expenses</h4>
                        <ul class="field-list">
                            <li><span class="field-name">amount</span> <span class="field-type">number</span></li>
                            <li><span class="field-name">reason</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">date</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">type</span> <span class="field-type">string</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanExpenses" checked>
                            <label for="cleanExpenses">Clean this collection</label>
                        </div>
                    </div>

                    <div class="collection-card">
                        <h4>üìä Exam Attendance</h4>
                        <ul class="field-list">
                            <li><span class="field-name">examId</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">studentId</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">attended</span> <span class="field-type">boolean</span></li>
                            <li><span class="field-name">feePaid</span> <span class="field-type">number</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanExamAttendance" checked>
                            <label for="cleanExamAttendance">Clean this collection</label>
                        </div>
                    </div>

                    <div class="collection-card">
                        <h4>üéØ Marks</h4>
                        <ul class="field-list">
                            <li><span class="field-name">examId</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">studentId</span> <span class="field-type">string</span></li>
                            <li><span class="field-name">marks</span> <span class="field-type">number</span></li>
                            <li><span class="field-name">grade</span> <span class="field-type">string</span></li>
                        </ul>
                        <div class="checkbox-group" style="margin-top: 15px;">
                            <input type="checkbox" id="cleanMarks" checked>
                            <label for="cleanMarks">Clean this collection</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Field Configuration -->
            <div class="section">
                <h3>‚öôÔ∏è Field Configuration</h3>
                <div class="form-group">
                    <label for="fieldsToRemove">Fields to Remove (comma-separated):</label>
                    <textarea id="fieldsToRemove" rows="3" placeholder="tempField, oldField, unusedField, debug, test"></textarea>
                </div>
                <div class="form-group">
                    <label for="fieldsToKeep">Fields to Keep (comma-separated, optional):</label>
                    <textarea id="fieldsToKeep" rows="3" placeholder="Leave empty to use default field lists"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="section">
                <h3>üöÄ Actions</h3>
                <button class="btn btn-warning" onclick="runDryRun()">üîç Run Dry Run</button>
                <button class="btn btn-danger" onclick="runLiveCleanup()">‚ö†Ô∏è Run Live Cleanup</button>
                <button class="btn btn-success" onclick="clearLogs()">üßπ Clear Logs</button>
                <button class="btn" onclick="exportLogs()">üì• Export Logs</button>
            </div>

            <!-- Log Output -->
            <div class="log-container" id="logContainer">
                <div id="logContent"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClXV9PzskFjGVzTa2OVG3nJQZ170qjrrE",
            authDomain: "pesalai-undergraduate.firebaseapp.com",
            projectId: "pesalai-undergraduate",
            storageBucket: "pesalai-undergraduate.firebasestorage.app",
            messagingSenderId: "819849679669",
            appId: "1:819849679669:web:418491be5cbfa0fc62b27c",
            measurementId: "G-T9X602C1X2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let isProcessing = false;
        const BATCH_SIZE = 10;

        // Collection configurations
        const COLLECTIONS_CONFIG = {
            'students': {
                fieldsToKeep: ['indexNo', 'name', 'batch', 'phone', 'email', 'address']
            },
            'classAttendance': {
                fieldsToKeep: ['date', 'studentId', 'attended', 'timestamp']
            },
            'exams': {
                fieldsToKeep: ['batch', 'subject', 'date', 'status', 'attendance', 'totalIncome']
            },
            'expenses': {
                fieldsToKeep: ['amount', 'reason', 'date', 'type']
            },
            'examAttendance': {
                fieldsToKeep: ['examId', 'studentId', 'attended', 'feePaid']
            },
            'marks': {
                fieldsToKeep: ['examId', 'studentId', 'marks', 'grade']
            }
        };

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logContent = document.getElementById('logContent');
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContent.appendChild(logEntry);
            logContainer.classList.add('active');
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function getSelectedCollections() {
            const collections = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="clean"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const collectionName = checkbox.id.replace('clean', '').toLowerCase();
                    if (collectionName === 'classattendance') {
                        collections.push('classAttendance');
                    } else if (collectionName === 'examattendance') {
                        collections.push('examAttendance');
                    } else {
                        collections.push(collectionName);
                    }
                }
            });
            
            return collections;
        }

        function getFieldsToRemove() {
            const fieldsInput = document.getElementById('fieldsToRemove').value;
            return fieldsInput.split(',').map(field => field.trim()).filter(field => field.length > 0);
        }

        function getFieldsToKeep() {
            const fieldsInput = document.getElementById('fieldsToKeep').value;
            if (fieldsInput.trim()) {
                return fieldsInput.split(',').map(field => field.trim()).filter(field => field.length > 0);
            }
            return null;
        }

        async function removeFieldsFromCollection(collectionName, fieldsToRemove, fieldsToKeep, isDryRun = true) {
            log(`Starting cleanup for collection: ${collectionName}`);
            
            try {
                const collectionRef = collection(db, collectionName);
                const snapshot = await getDocs(collectionRef);
                
                if (snapshot.empty) {
                    log(`Collection ${collectionName} is empty`);
                    return;
                }
                
                log(`Found ${snapshot.docs.length} documents in ${collectionName}`);
                
                const docsToUpdate = [];
                
                // Analyze documents and prepare updates
                snapshot.docs.forEach(docSnapshot => {
                    const docData = docSnapshot.data();
                    const docId = docSnapshot.id;
                    
                    if (fieldsToRemove && fieldsToRemove.length > 0) {
                        // Remove specific fields
                        const fieldsToRemoveFromDoc = fieldsToRemove.filter(field => docData.hasOwnProperty(field));
                        if (fieldsToRemoveFromDoc.length > 0) {
                            docsToUpdate.push({
                                id: docId,
                                data: docData,
                                fieldsToRemove: fieldsToRemoveFromDoc,
                                action: 'removeFields'
                            });
                        }
                    }
                    
                    if (fieldsToKeep && fieldsToKeep.length > 0) {
                        // Keep only specific fields (remove all others)
                        const fieldsToRemoveFromDoc = Object.keys(docData).filter(field => !fieldsToKeep.includes(field));
                        if (fieldsToRemoveFromDoc.length > 0) {
                            docsToUpdate.push({
                                id: docId,
                                data: docData,
                                fieldsToRemove: fieldsToRemoveFromDoc,
                                action: 'keepOnlyFields'
                            });
                        }
                    }
                });
                
                if (docsToUpdate.length === 0) {
                    log(`No documents need updating in ${collectionName}`);
                    return;
                }
                
                log(`Found ${docsToUpdate.length} documents to update in ${collectionName}`);
                
                // Process in batches
                for (let i = 0; i < docsToUpdate.length; i += BATCH_SIZE) {
                    const batch = docsToUpdate.slice(i, i + BATCH_SIZE);
                    await processBatch(collectionName, batch, isDryRun);
                }
                
                log(`Completed cleanup for collection: ${collectionName}`, 'success');
                
            } catch (error) {
                log(`Error cleaning collection ${collectionName}: ${error.message}`, 'error');
            }
        }

        async function processBatch(collectionName, batch, isDryRun = true) {
            if (isDryRun) {
                log(`[DRY RUN] Would process batch of ${batch.length} documents in ${collectionName}`);
                batch.forEach(doc => {
                    log(`[DRY RUN] Would ${doc.action} fields: ${doc.fieldsToRemove.join(', ')} from document ${doc.id}`);
                });
                return;
            }
            
            try {
                const firestoreBatch = writeBatch(db);
                
                batch.forEach(docUpdate => {
                    const docRef = doc(db, collectionName, docUpdate.id);
                    
                    if (docUpdate.action === 'removeFields') {
                        // Remove specific fields
                        const updateData = {};
                        docUpdate.fieldsToRemove.forEach(field => {
                            updateData[field] = null; // Firestore uses null to delete fields
                        });
                        firestoreBatch.update(docRef, updateData);
                    } else if (docUpdate.action === 'keepOnlyFields') {
                        // Keep only specific fields (recreate document with only desired fields)
                        const newData = {};
                        COLLECTIONS_CONFIG[collectionName].fieldsToKeep.forEach(field => {
                            if (docUpdate.data.hasOwnProperty(field)) {
                                newData[field] = docUpdate.data[field];
                            }
                        });
                        firestoreBatch.set(docRef, newData);
                    }
                });
                
                await firestoreBatch.commit();
                log(`Successfully processed batch of ${batch.length} documents in ${collectionName}`, 'success');
                
            } catch (error) {
                log(`Error processing batch in ${collectionName}: ${error.message}`, 'error');
            }
        }

        // Main cleanup function
        async function runCleanup(isDryRun = true) {
            if (isProcessing) {
                log('Cleanup already in progress', 'warning');
                return;
            }

            isProcessing = true;
            const mode = isDryRun ? 'DRY RUN' : 'LIVE';
            
            log(`Starting database cleanup process - ${mode} mode`);
            
            try {
                const selectedCollections = getSelectedCollections();
                const fieldsToRemove = getFieldsToRemove();
                const fieldsToKeep = getFieldsToKeep();
                
                if (selectedCollections.length === 0) {
                    log('No collections selected for cleanup', 'warning');
                    return;
                }
                
                if (fieldsToRemove.length === 0 && !fieldsToKeep) {
                    log('No fields specified for removal', 'warning');
                    return;
                }
                
                log(`Selected collections: ${selectedCollections.join(', ')}`);
                if (fieldsToRemove.length > 0) {
                    log(`Fields to remove: ${fieldsToRemove.join(', ')}`);
                }
                if (fieldsToKeep) {
                    log(`Fields to keep: ${fieldsToKeep.join(', ')}`);
                }
                
                for (const collectionName of selectedCollections) {
                    await removeFieldsFromCollection(collectionName, fieldsToRemove, fieldsToKeep, isDryRun);
                }
                
                log(`Database cleanup completed successfully - ${mode} mode`, 'success');
                
            } catch (error) {
                log(`Cleanup failed: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
            }
        }

        // Global functions for buttons
        window.runDryRun = () => runCleanup(true);
        window.runLiveCleanup = () => {
            if (confirm('‚ö†Ô∏è WARNING: This will make actual changes to your database! Are you sure you want to proceed?')) {
                runCleanup(false);
            }
        };
        
        window.clearLogs = () => {
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('logContainer').classList.remove('active');
        };
        
        window.exportLogs = () => {
            const logContent = document.getElementById('logContent').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cleanup-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Initialize
        log('Database Cleanup Tool initialized', 'success');
        log('Select collections and fields to clean, then run a dry run first', 'info');
    </script>
</body>
</html>
